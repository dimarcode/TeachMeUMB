{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
    <h1>Edit Profile</h1>
    <div class="row">
        <div class="col-md-4 text-center mb-4">
            {% if current_user.profile_picture %}
                <img src="{{ url_for('static', filename='profile_pictures/' + current_user.profile_picture) }}" alt="Profile Picture" class="img-thumbnail mb-2" width="150" id="currentProfilePic">
                <form method="POST" action="{{ url_for('remove_profile_picture') }}" style="display:inline;">
                    {{ form.hidden_tag() }}
                    <button type="submit" class="btn btn-danger btn-sm mt-2">Remove Profile Picture</button>
                </form>
            {% endif %}
        </div>
        <div class="col-md-8">
            <form method="POST" enctype="multipart/form-data">
                {{ form.hidden_tag() }}
                <div class="form-group mb-3">
                    <label for="profile_picture">Profile Picture</label>
                    <input type="file" id="profile_picture_input" name="profile_picture" accept="image/*" class="form-control-file">
                    <button type="button" id="openCropperModalBtn" class="btn btn-primary d-none" data-bs-toggle="modal" data-bs-target="#staticBackdrop">
                        Launch Cropper Modal
                    </button>
                    {% for error in form.profile_picture.errors %}
                        <span class="text-danger">{{ error }}</span>
                    {% endfor %}
                </div>
                <div class="form-group mb-3">
                    <label for="username">Username</label>
                    {{ form.username(class="form-control") }}
                    {% for error in form.username.errors %}
                        <span class="text-danger">{{ error }}</span>
                    {% endfor %}
                </div>
                <div class="form-group mb-3">
                    <label for="about_me">About Me</label>
                    {{ form.about_me(class="form-control") }}
                    {% for error in form.about_me.errors %}
                        <span class="text-danger">{{ error }}</span>
                    {% endfor %}
                </div>
                <button type="submit" class="btn btn-success">Save Changes</button>
                <input type="hidden" id="cropped_image_data" name="cropped_image_data">
            </form>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="staticBackdropLabel">Crop Profile Picture</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center" style="min-width:400px; min-height:400px; display:flex; justify-content:center; align-items:center;">
                <img id="cropper_preview" style="max-width: 90vw; max-height: 70vh; width: 300px; height: 300px; display: none;">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="cropImageBtn" class="btn btn-primary">Crop & Upload</button>
            </div>
        </div>
    </div>
</div>

<script>
let cropper;
const input = document.getElementById('profile_picture_input');
const preview = document.getElementById('cropper_preview');
const cropperModal = document.getElementById('staticBackdrop');
const openCropperModalBtn = document.getElementById('openCropperModalBtn');
const cropImageBtn = document.getElementById('cropImageBtn');

let imageReady = false;
let imageDataUrl = null;

input.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(event) {
        imageDataUrl = event.target.result;
        imageReady = true;
        openCropperModalBtn.click();
    };
    reader.readAsDataURL(file);
});

cropperModal.addEventListener('shown.bs.modal', function () {
    if (imageReady && imageDataUrl) {
        preview.src = imageDataUrl;
        if (cropper) cropper.destroy();
        cropper = new Cropper(preview, {
            aspectRatio: 1,
            viewMode: 1,
            autoCropArea: 1
        });
        imageReady = false;
    }
    preview.focus();
});

cropImageBtn.addEventListener('click', function() {
    if (cropper) {
        cropper.getCroppedCanvas().toBlob(function(blob) {
            const form = document.querySelector('form');
            const formData = new FormData(form);
            formData.set('profile_picture', blob, 'profile_picture.png');
            fetch(form.action, {
                method: 'POST',
                body: formData
            }).then(response => {
                if (response.redirected) {
                    window.location.href = response.url;
                } else {
                    window.location.reload();
                }
            });
        }, 'image/png');
        var modal = bootstrap.Modal.getInstance(cropperModal);
        modal.hide();
    }
});
</script>
{% endblock %}