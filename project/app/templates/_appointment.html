<tr>
    <td colspan="8">
      <div class="card shadow-sm mb-3 border-light">
        
        <!-- Clickable Header with Location and Hint -->
        <div class="card-header d-flex justify-content-between align-items-center"
             data-bs-toggle="collapse"
             data-bs-target="#details{{ appointment.id }}"
             role="button"
             style="cursor: pointer;">
          <div>
            <strong>#{{ appointment.id }}</strong> â€“ {{ appointment.subject.name }}  
            <span class="text-muted">
              ({{ appointment.booking_date.strftime('%b %d') }} at {{ moment(appointment.booking_time).format('LT') }} @ {{ appointment.location.replace('_', ' ') | title }})
            </span>
          </div>
          <div class="text-muted small d-none d-md-block"><em>Click to view details</em></div>
        </div>
  
        <!-- Collapsible Details -->
        <div id="details{{ appointment.id }}" class="collapse">
          <div class="card-body">
            <div class="row text-center gy-2">
              
              <!-- Student or Tutor -->
              <div class="col-md-3">
                {% if current_user.role == UserRole.TUTOR %}
                  <small>Student</small><br>
                  <img src="{{ appointment.student.avatar(25) }}" class="rounded-circle">
                  <div><a href="{{ url_for('user', username=appointment.student.username) }}">{{ appointment.student.username }}</a></div>
                {% else %}
                  <small>Tutor</small><br>
                  <img src="{{ appointment.tutor.avatar(25) }}" class="rounded-circle">
                  <div><a href="{{ url_for('user', username=appointment.tutor.username) }}">{{ appointment.tutor.username }}</a></div>
                {% endif %}
              </div>
  
              <!-- Subject -->
              <div class="col-md-3">
                <small>Subject</small><br>
                {{ appointment.subject.name }}<br>
                <small class="text-muted">{{ appointment.subject.topic }}</small>
              </div>
  
              <!-- Location and Status -->
              <div class="col-md-3">
                <small>Location</small><br>
                {{ appointment.location.replace('_', ' ') | title }}<br>
                <span class="badge bg-secondary mt-1">{{ appointment.status }}</span>
              </div>
  
              <!-- Actions -->
              <div class="col-md-3 d-flex flex-column align-items-center gap-1">
                <a href="{{ url_for('appointment_update', appointment_id=appointment.id) }}" class="btn btn-outline-primary btn-sm">Update</a>
                {% if appointment.status == 'pending' and current_user.role.value != appointment.last_updated_by.value %}
                  <form action="{{ url_for('confirm_appointment', appointment_id=appointment.id) }}" method="post">
                    {{ form.hidden_tag() }}
                    <button type="submit" class="btn btn-success btn-sm">Confirm</button>
                  </form>
                {% endif %}
                {% if appointment.status == 'confirmed' and current_user.role == UserRole.TUTOR %}
                  <a href="{{ url_for('begin_appointment', appointment_id=appointment.id) }}" class="btn btn-success btn-sm">Begin</a>
                {% endif %}
                <form action="{{ url_for('remove_appointment', appointment_id=appointment.id) }}" method="post">
                  {{ form.hidden_tag() }}
                  <button type="submit" class="btn btn-danger btn-sm">Cancel</button>
                </form>
              </div>
  
            </div>
          </div>
        </div>
        
      </div>
    </td>
  </tr>
  